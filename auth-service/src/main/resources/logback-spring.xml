<!-- Professional microservices logging configuration -->
<configuration>
  <springProperty scope="context" name="APP_NAME" source="spring.application.name"
    defaultValue="auth-service" />
  <springProperty scope="context" name="LOG_LEVEL" source="logging.level.root" defaultValue="INFO" />

  <!-- ========================================= -->
  <!-- DEVELOPMENT ENVIRONMENT -->
  <!-- ========================================= -->
  <springProfile name="dev,local">
    <!-- Console with readable format for development -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
      <encoder>
        <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} [%X{traceId:-},%X{spanId:-}] -
          %msg%n</pattern>
      </encoder>
    </appender>

    <!-- File for debugging (optional in dev) -->
    <appender name="DEV_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
      <file>logs/${APP_NAME}-dev.log</file>
      <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
        <fileNamePattern>logs/${APP_NAME}-dev.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
        <maxFileSize>50MB</maxFileSize>
        <maxHistory>7</maxHistory>
        <totalSizeCap>500MB</totalSizeCap>
      </rollingPolicy>
      <encoder>
        <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36}
          [%X{traceId:-},%X{spanId:-}] - %msg%n</pattern>
      </encoder>
    </appender>

    <root level="DEBUG">
      <appender-ref ref="CONSOLE" />
    </root>

    <logger name="com.ifoodclone" level="DEBUG" />
    <logger name="org.springframework.security" level="DEBUG" />
  </springProfile>

  <!-- ========================================= -->
  <!-- TEST ENVIRONMENT -->
  <!-- ========================================= -->
  <springProfile name="test">
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
      <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
        <providers>
          <timestamp />
          <logLevel />
          <loggerName />
          <message />
          <mdc />
          <pattern>
            <pattern>
              {"service":"${APP_NAME}","env":"test","traceId":"%X{traceId:-}","spanId":"%X{spanId:-}"}</pattern>
          </pattern>
        </providers>
      </encoder>
    </appender>

    <root level="INFO">
      <appender-ref ref="CONSOLE" />
    </root>

    <logger name="com.ifoodclone" level="INFO" />
  </springProfile>

  <!-- ========================================= -->
  <!-- DOCKER/CONTAINER ENVIRONMENT -->
  <!-- ========================================= -->
  <springProfile name="docker">
    <!-- Simple console output for Docker containers -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
      <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
        <providers>
          <timestamp>
            <timeZone>UTC</timeZone>
          </timestamp>
          <logLevel />
          <loggerName />
          <message />
          <mdc />
          <stackTrace />
          <pattern>
            <pattern>
              {
              "service": "${APP_NAME}",
              "environment": "docker",
              "thread": "%thread",
              "traceId": "%X{traceId:-}",
              "spanId": "%X{spanId:-}",
              "userId": "%X{userId:-}",
              "requestId": "%X{requestId:-}"
              }
            </pattern>
          </pattern>
        </providers>
      </encoder>
    </appender>

    <!-- Loki integration (when available) -->
    <if condition='isDefined("LOKI_URL")'>
      <then>
        <appender name="LOKI" class="com.github.loki4j.logback.Loki4jAppender">
          <http>
            <url>${LOKI_URL}/loki/api/v1/push</url>
          </http>
          <format>
            <label>
              <pattern>service=${APP_NAME},env=docker,level=%level,host=%X{hostname:-unknown}</pattern>
            </label>
            <message>
              <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%X{traceId:-},%X{spanId:-}] %logger{36}
                - %msg</pattern>
            </message>
          </format>
        </appender>

        <appender name="ASYNC_LOKI" class="ch.qos.logback.classic.AsyncAppender">
          <appender-ref ref="LOKI" />
          <queueSize>256</queueSize>
          <discardingThreshold>0</discardingThreshold>
        </appender>
      </then>
    </if>

    <root level="INFO">
      <appender-ref ref="CONSOLE" />
      <if condition='isDefined("LOKI_URL")'>
        <then>
          <appender-ref ref="ASYNC_LOKI" />
        </then>
      </if>
    </root>

    <!-- Application specific loggers -->
    <logger name="com.ifoodclone.auth" level="INFO" />
    <logger name="org.springframework.security" level="INFO" />
    <logger name="io.jsonwebtoken" level="WARN" />
    <logger name="org.springframework.data.redis" level="INFO" />

    <!-- Framework loggers -->
    <logger name="org.springframework.web" level="INFO" />
    <logger name="org.springframework.cloud" level="INFO" />
    <logger name="com.netflix.eureka" level="WARN" />
    <logger name="org.apache.kafka" level="WARN" />

    <!-- Performance monitoring -->
    <logger name="org.springframework.boot.actuator" level="INFO" />

    <!-- Reduce noise -->
    <logger name="org.springframework.boot.autoconfigure" level="WARN" />
    <logger name="org.hibernate" level="WARN" />
    <logger name="com.zaxxer.hikari" level="WARN" />
  </springProfile>

  <!-- ========================================= -->
  <!-- PRODUCTION ENVIRONMENT -->
  <!-- ========================================= -->
  <springProfile name="prod,production">
    <!-- Structured JSON logs for production -->
    <appender name="PROD_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
      <file>/var/log/apps/${APP_NAME}/${APP_NAME}.json</file>
      <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
        <fileNamePattern>/var/log/apps/${APP_NAME}/${APP_NAME}.%d{yyyy-MM-dd}.%i.json.gz</fileNamePattern>
        <maxFileSize>1GB</maxFileSize>
        <maxHistory>30</maxHistory>
        <totalSizeCap>30GB</totalSizeCap>
      </rollingPolicy>
      <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
        <providers>
          <timestamp>
            <timeZone>UTC</timeZone>
          </timestamp>
          <version />
          <logLevel />
          <loggerName />
          <message />
          <mdc />
          <stackTrace />
          <pattern>
            <pattern>
              {
              "service": "${APP_NAME}",
              "environment": "production",
              "server": "%X{hostname:-unknown}",
              "thread": "%thread",
              "traceId": "%X{traceId:-}",
              "spanId": "%X{spanId:-}",
              "userId": "%X{userId:-}",
              "requestId": "%X{requestId:-}",
              "correlationId": "%X{correlationId:-}"
              }
            </pattern>
          </pattern>
        </providers>
      </encoder>
    </appender>

    <!-- Console for container logs -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
      <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
        <providers>
          <timestamp />
          <logLevel />
          <loggerName />
          <message />
          <pattern>
            <pattern>{"service":"${APP_NAME}","env":"prod","traceId":"%X{traceId:-}"}</pattern>
          </pattern>
        </providers>
      </encoder>
    </appender>

    <!-- Async wrappers for performance -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
      <appender-ref ref="PROD_FILE" />
      <queueSize>1024</queueSize>
      <discardingThreshold>0</discardingThreshold>
      <includeCallerData>false</includeCallerData>
    </appender>

    <root level="INFO">
      <appender-ref ref="CONSOLE" />
      <appender-ref ref="ASYNC_FILE" />
    </root>

    <!-- Production loggers - more restrictive -->
    <logger name="com.ifoodclone.auth" level="INFO" />
    <logger name="org.springframework.security" level="WARN" />
    <logger name="org.springframework" level="WARN" />
    <logger name="org.hibernate" level="ERROR" />

    <!-- Security events - always log -->
    <logger name="SECURITY" level="INFO" additivity="false">
      <appender-ref ref="ASYNC_FILE" />
    </logger>

    <!-- Business events - always log -->
    <logger name="BUSINESS" level="INFO" additivity="false">
      <appender-ref ref="ASYNC_FILE" />
    </logger>
  </springProfile>
</configuration>